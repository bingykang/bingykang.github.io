var TNC=function(v){"use strict";v.ECacheMode=void 0,function(e){e.cache_only="cache_only",e.cache_first="cache_first"}(v.ECacheMode||(v.ECacheMode={}));var fe=function(e,t){return fe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},fe(e,t)};function ht(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");fe(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}var R=function(){return R=Object.assign||function(t){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},R.apply(this,arguments)};function ft(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r}function T(e,t,r,n){function i(o){return o instanceof r?o:new r(function(a){a(o)})}return new(r||(r=Promise))(function(o,a){function c(d){try{u(n.next(d))}catch(l){a(l)}}function s(d){try{u(n.throw(d))}catch(l){a(l)}}function u(d){d.done?o(d.value):i(d.value).then(c,s)}u((n=n.apply(e,t||[])).next())})}function b(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,a;return a={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function c(u){return function(d){return s([u,d])}}function s(u){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,i=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){r=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){r.label=u[1];break}if(u[0]===6&&r.label<o[1]){r.label=o[1],o=u;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(u);break}o[2]&&r.ops.pop(),r.trys.pop();continue}u=t.call(e,r)}catch(d){u=[6,d],i=0}finally{n=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function V(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}var O;(function(e){e.tc="tc",e.dispatch="dispatch",e.web_tc="web_tc",e.web_dispatch="web_dispatch"})(O||(O={}));var q;(function(e){e[e.baseReplace=1]="baseReplace",e[e.elimination=3]="elimination",e[e.bestRouting=4]="bestRouting",e[e.dynamicRouting=5]="dynamicRouting",e[e.orderTry=101]="orderTry"})(q||(q={}));function vt(e){var t,r,n=e.dbUtilCore,i=e.operateParams,o=n.dbProps.dbName,a=n.dbProps.dbVersion,c="tnc_".concat(o||"","_").concat(a||"","_").concat(i.tableName);if(i.key){var s=Array.isArray(i.key)?i.key.join("-"):i.key;return c+"_"+s}var u=(t=n.dbProps.tableStructures.find(function(l){return l.name===i.tableName}))===null||t===void 0?void 0:t.storeParameters.keyPath;if(!u)return c;var d=Array.isArray(u)?u.map(function(l){var h;return((h=i.value)===null||h===void 0?void 0:h[l])||""}).join("-"):((r=i.value)===null||r===void 0?void 0:r[u])||"";return c+"_"+d}function $(e){var t=e.dbUtilCore,r=e.operateParams,n=vt({dbUtilCore:t,operateParams:r});switch(r.operateType){case"get":var i=window.localStorage.getItem(n);if(!i)return null;try{return JSON.parse(i)}catch(o){return null}case"add":case"put":return window.localStorage.setItem(n,JSON.stringify(r.value));case"delete":return window.localStorage.removeItem(n)}}var Me=function(){function e(t){this.dbProps=t}return e.prototype.init=function(){return T(this,void 0,void 0,function(){var t=this;return b(this,function(r){return[2,new Promise(function(n,i){var o=indexedDB.open(t.dbProps.dbName,t.dbProps.dbVersion);o.onsuccess=function(a){var c=a.target.result;t.db=c,n(c)},o.onerror=function(a){i(a)},o.onupgradeneeded=function(a){t.dbProps.tableStructures.forEach(function(c){var s;(s=a.target.result)===null||s===void 0||s.createObjectStore(c.name,c.storeParameters)})}})]})})},e.prototype.getDb=function(){return T(this,void 0,void 0,function(){return b(this,function(t){switch(t.label){case 0:return this.db?[2,this.db]:[4,this.init()];case 1:return[2,t.sent()]}})})},e.prototype.closeDb=function(){var t;(t=this.db)===null||t===void 0||t.close()},e}();function pt(){return!!window.indexedDB}function B(e){var t=this,r=e.storeType,n=e.dbUtilCore,i=e.operateParams;return r==="localStorage"?$({dbUtilCore:n,operateParams:i}):function(){return T(t,void 0,void 0,function(){var o,a;return b(this,function(c){switch(c.label){case 0:return[4,n.getDb()];case 1:return o=c.sent(),a=o.transaction(i.tableName,i.operateType==="get"?"readonly":"readwrite").objectStore(i.tableName),[2,new Promise(function(s,u){var d;switch(i.operateType){case"get":case"delete":d=a[i.operateType](i.key);break;case"add":case"put":d=a[i.operateType](i.value,i.key);break}d.onsuccess=function(){s(d.result)},d.onerror=function(l){u(l)}})]}})})}()}var gt=1;v.ETableNames=void 0,function(e){e.tnc_config_table="tnc_config_table",e.tnc_dynamic_routing="tnc_dynamic_routing",e.tnc_elimination="tnc_elimination",e.tnc_best_routing="tnc_best_routing"}(v.ETableNames||(v.ETableNames={}));var _t=[{name:v.ETableNames.tnc_config_table,storeParameters:{keyPath:["aid"]}},{name:v.ETableNames.tnc_dynamic_routing,storeParameters:{keyPath:"ttnet_dispatch_actions_epoch"}},{name:v.ETableNames.tnc_elimination,storeParameters:{keyPath:"ttnet_dispatch_actions_epoch"}},{name:v.ETableNames.tnc_best_routing,storeParameters:{keyPath:"ttnet_dispatch_actions_epoch"}}],A=new Me({dbName:"TNC_STORE_V1",dbVersion:gt,tableStructures:_t});function K(e){var t=this,r=e||{},n=r.aid,i=n===void 0?"-1":n,o=r.storeType,a=o===void 0?"localStorage":o,c={dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_config_table,key:[i]}};if(a==="localStorage"){var s=B(R(R({},c),{storeType:a}));return s==null?void 0:s.tncSchema}return function(){return T(t,void 0,void 0,function(){var u;return b(this,function(d){switch(d.label){case 0:return[4,B(R(R({},c),{storeType:a}))];case 1:return u=d.sent(),[2,u==null?void 0:u.tncSchema]}})})}()}function ve(e){var t=this,r=e.aid,n=r===void 0?"-1":r,i=e.tncSchema,o=e.storeType,a=o===void 0?"localStorage":o,c={dbUtilCore:A,operateParams:{operateType:"put",tableName:v.ETableNames.tnc_config_table,value:{aid:n,tncSchema:i}}};return a==="localStorage"?B(R(R({},c),{storeType:a})):function(){return T(t,void 0,void 0,function(){return b(this,function(s){switch(s.label){case 0:return[4,B(R(R({},c),{storeType:a}))];case 1:return[2,s.sent()]}})})}()}function Y(e){var t=this,r=e.tncSchema,n=e.storeType,i=n===void 0?"localStorage":n,o=(r||{}).ttnet_dispatch_actions_epoch;if(o){var a={dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_dynamic_routing,key:o}};return i==="localStorage"?B(R(R({},a),{storeType:i})):function(){return T(t,void 0,void 0,function(){return b(this,function(c){switch(c.label){case 0:return[4,B(R(R({},a),{storeType:i}))];case 1:return[2,c.sent()]}})})}()}}function pe(e){var t=this,r=e.sign,n=e.host,i=e.tncSchema,o=e.storeType,a=o===void 0?"localStorage":o,c=(i||{}).ttnet_dispatch_actions_epoch;if(c){if(a==="localStorage"){var s=$({dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_dynamic_routing,key:c}}),u=ke({tncSchema:i,dynamicRoutingData:s,sign:r,host:n});return $({dbUtilCore:A,operateParams:{operateType:"put",tableName:v.ETableNames.tnc_dynamic_routing,key:c,value:u}}),u}return function(){return T(t,void 0,void 0,function(){var d;return b(this,function(l){switch(l.label){case 0:return[4,A.getDb()];case 1:return d=l.sent(),[2,new Promise(function(h,f){if(!d||!c)return f(null);var _=d.transaction([v.ETableNames.tnc_dynamic_routing],"readwrite").objectStore(v.ETableNames.tnc_dynamic_routing),y=_.get(c);y.onsuccess=function(){var g=y.result,p=ke({tncSchema:i,dynamicRoutingData:g,sign:r,host:n}),w=_.put(p);w.onsuccess=function(){h(p)},w.onerror=function(S){f(S)}},y.onerror=function(g){f(g)}})]}})})}()}}function ke(e){var t=e.tncSchema,r=e.dynamicRoutingData,n=e.sign,i=e.host,o=(t||{}).ttnet_dispatch_actions_epoch,a=r||{ttnet_dispatch_actions_epoch:o,routing:{}};return i?a.routing[n]={result:i}:Reflect.deleteProperty(a.routing,n),a}var Ee="tnc_update_schema",Oe="tnc_update_dynamic_routing";function le(e){var t,r;((r=(t=navigator.serviceWorker)===null||t===void 0?void 0:t.controller)===null||r===void 0?void 0:r.state)==="activated"&&navigator.serviceWorker.controller.postMessage(e)}var qe=function(){function e(t){this.status="stop",this.tncSchema=t.tncSchema,this.storeType=t.storeType||"localStorage"}return e.prototype.start=function(){var t=this;this.status="running",setTimeout(function(){t.startRoutingTask()},3e3)},e.prototype.stop=function(){this.routingTaskTimer&&clearTimeout(this.routingTaskTimer),this.status="stop"},e.prototype.setTncSchema=function(t){var r=this,n,i=this.tncSchema;this.tncSchema=t,this.status==="running"&&(i?(i==null?void 0:i.ttnet_dispatch_actions_epoch)!==((n=this.tncSchema)===null||n===void 0?void 0:n.ttnet_dispatch_actions_epoch)&&this.startRoutingTask():setTimeout(function(){r.startRoutingTask()},3e3))},e.prototype.runRoutingTaskOnce=function(){var t,r,n;return T(this,void 0,void 0,function(){var i,o=this;return b(this,function(a){switch(a.label){case 0:i=(n=(r=(t=this.tncSchema)===null||t===void 0?void 0:t.ttnet_dispatch_actions)===null||r===void 0?void 0:r.filter(function(c){return c.param.dispatch_strategy===q.dynamicRouting}))===null||n===void 0?void 0:n.map(function(c){return o.routingActionTask(c)}),a.label=1;case 1:return a.trys.push([1,6,,7]),i!=null&&i.length?[4,Promise.all(i)]:[3,3];case 2:return a.sent(),[3,5];case 3:return[4,Promise.resolve()];case 4:a.sent(),a.label=5;case 5:return[3,7];case 6:return a.sent(),[3,7];case 7:return[2]}})})},e.prototype.startRoutingTask=function(){var t=this;if(this.routingTaskTimer&&clearTimeout(this.routingTaskTimer),!!this.tncSchema){var r=function(){return T(t,void 0,void 0,function(){var n,i=this,o,a,c,s;return b(this,function(u){switch(u.label){case 0:n=(c=(a=(o=this.tncSchema)===null||o===void 0?void 0:o.ttnet_dispatch_actions)===null||a===void 0?void 0:a.filter(function(d){return d.param.dispatch_strategy===q.dynamicRouting}))===null||c===void 0?void 0:c.map(function(d){return i.routingActionTask(d)}),u.label=1;case 1:return u.trys.push([1,6,,7]),n!=null&&n.length?[4,Promise.all(n)]:[3,3];case 2:return u.sent(),[3,5];case 3:return[4,Promise.resolve()];case 4:u.sent(),u.label=5;case 5:return[3,7];case 6:return u.sent(),[3,7];case 7:return this.routingTaskTimer=setTimeout(r,!((s=this.tncSchema)===null||s===void 0)&&s.route_selection_trigger_interval?this.tncSchema.route_selection_trigger_interval*1e3:18e5),[2]}})})};r()}},e.prototype.routingActionTask=function(t){var r,n,i;return T(this,void 0,void 0,function(){var o,a,c,s,u,h,d,y,l,h,f,_,y,g=this;return b(this,function(p){switch(p.label){case 0:if(!this.tncSchema||t.param.dispatch_strategy!==q.dynamicRouting)return[2];if(o=t.param.strategy_info,a=(i=(n=(r=Y({tncSchema:this.tncSchema,storeType:"localStorage"}))===null||r===void 0?void 0:r.routing)===null||n===void 0?void 0:n[t.sign])===null||i===void 0?void 0:i.result,o.working_mode!==1)return[3,6];c=void 0,s=0,u=function(w){var S,m;return b(this,function(D){switch(D.label){case 0:return[4,Promise.all(o.candidates.map(function(P){return g.fetchRoutingPath({path:"".concat(P.host,"/ies/speed/"),threshold:P.threshold,scheme_option:o.scheme_option,error_code:o.error_code})}))];case 1:if(S=D.sent(),S.forEach(function(P,C){if(P.status!==0){var U=o.candidates[C],I=(U.host===a&&U.weight_increase_percent_if_using?P.time*((100-U.weight_increase_percent_if_using)/100)+(U.weight||0):P.time)+(U.weight||0);(!m||I<m.time)&&(m={host:U.host,time:I,candidate:U})}}),(m==null?void 0:m.host)===a)return c=m==null?void 0:m.host,[2,"break"];if(!c||(m==null?void 0:m.host)===c)c=m==null?void 0:m.host,s++;else return c=a,[2,"break"];return!(m!=null&&m.candidate.consecutive_fastest)||s>=m.candidate.consecutive_fastest?[2,"break"]:[2]}})},h=0,p.label=1;case 1:return h<10?[5,u(h)]:[3,4];case 2:if(d=p.sent(),d==="break")return[3,4];p.label=3;case 3:return h++,[3,1];case 4:return[4,pe({sign:t.sign,host:c,tncSchema:this.tncSchema,storeType:this.storeType})];case 5:y=p.sent(),y&&le({action:"tnc_update_dynamic_routing",payload:y}),p.label=6;case 6:if(o.working_mode!==2)return[3,12];l=void 0,h=0,p.label=7;case 7:return h<o.candidates.length?(f=o.candidates[h],[4,this.fetchRoutingPath({path:"".concat(f.host,"/ies/speed/"),threshold:f.threshold,scheme_option:o.scheme_option,error_code:o.error_code})]):[3,10];case 8:if(_=p.sent(),_.status===1)return l={host:f.host,time:_.time},[3,10];p.label=9;case 9:return h++,[3,7];case 10:return[4,pe({sign:t.sign,host:l==null?void 0:l.host,tncSchema:this.tncSchema,storeType:this.storeType})];case 11:y=p.sent(),y&&le({action:"tnc_update_dynamic_routing",payload:y}),p.label=12;case 12:return[2]}})})},e.prototype.fetchRoutingPath=function(t){var r=t.path,n=t.threshold,i=t.scheme_option,o=t.error_code;return T(this,void 0,void 0,function(){var a,c;return b(this,function(s){switch(s.label){case 0:switch(c=i,c){case 2:return[3,1];case 3:return[3,3];case 1:return[3,7]}return[3,7];case 1:return[4,de({url:"http://".concat(r),threshold:n,error_code:o})];case 2:return[2,s.sent()];case 3:return[4,de({url:"https://".concat(r),threshold:n,error_code:o})];case 4:return a=s.sent(),a.status!==1?[3,5]:[2,a];case 5:return[4,de({url:"http://".concat(r),threshold:n,error_code:o})];case 6:return[2,s.sent()];case 7:return[4,de({url:"https://".concat(r),threshold:n,error_code:o})];case 8:return[2,s.sent()]}})})},e}();function de(e){var t=e.url,r=e.threshold,n=e.error_code;return T(this,void 0,void 0,function(){var i,o,a,c;return b(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),i=Date.now(),[4,Promise.race(V([fetch(t)],r?[new Promise(function(u,d){setTimeout(d,r)})]:[],!0))];case 1:return o=s.sent(),a=Date.now()-i,c=o==null?void 0:o.status,!c||c&&(n!=null&&n.includes(c))?[2,{status:0,time:0}]:[2,{status:1,time:a}];case 2:return s.sent(),[2,{status:0,time:0}];case 3:return[2]}})})}var Ae=function(){function e(t){var r=t.tncConfig;this.tncConfig=R({region:"internal",storeType:"indexedDB"},r)}return e.prototype.updateUserId=function(t){this.tncConfig=R(R({},this.tncConfig),{user_id:t})},e.prototype.updateCustomHeaders=function(t){this.tncConfig=R(R({},this.tncConfig),{customHeaders:t})},e}();function mt(e){e=e.toLocaleLowerCase();var t=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(iphone)/.exec(e)||/(windows phone)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e),r=t==null?void 0:t[0],n=r==="ipad"||r==="ipod"||r==="iphone",i=r==="android",o=n||i||r==="windows phone",a=r==="win"||r==="mac"||r==="linux";return{isIos:n,isAndroid:i,isMobile:o,isDesktop:a}}function H(e){return e==null}var yt=["tnc-boe-server.byted.org"],bt=["tnc16-alisg.byteoversea.com"],St=["tnc3-bjlgy.zijieapi.com","tnc3-alisc1.zijieapi.com","tnc3-aliec2.zijieapi.com","101.36.166.16","101.36.166.17","101.36.166.18","101.36.166.19"];function Tt(e,t){return e+Math.floor(Math.random()*(t-e+1))}var je="__tnc_random_did";function Rt(){var e=parseInt(localStorage.getItem(je)||"");return e&&!Number.isNaN(e)||(e=Tt(1,Number.MAX_SAFE_INTEGER),localStorage.setItem(je,e.toString())),e}var Ne=function(){function e(t){this.status="stop",this.tncConfig=t.tncConfig,this.storeOnTncSchemaLoaded=t.onTncSchemaLoaded}return e.prototype.init=function(){var t,r,n;return T(this,void 0,void 0,function(){var i,o,a=this;return b(this,function(c){switch(c.label){case 0:return[4,K({aid:this.tncConfig.multiInstance?this.tncConfig.aid:void 0,storeType:this.getStoreType()})];case 1:return i=c.sent(),!((t=this.tncConfig)===null||t===void 0)&&t.defaultTncSchema&&(!i||!this.tncConfig.aid)&&(o=this.tncConfig.defaultTncSchema,ve({aid:this.tncConfig.multiInstance?this.tncConfig.aid:void 0,tncSchema:this.tncConfig.defaultTncSchema,storeType:this.getStoreType()})),this.tncConfig.aid?this.tncConfig.configure_update_policy!=="configuration request priority"?[3,3]:[4,ee({tncConfig:this.tncConfig,send_tnc_host_arrays:(r=this.tncSchema)===null||r===void 0?void 0:r.send_tnc_host_arrays,storeType:this.getStoreType()})]:[3,6];case 2:return o=c.sent(),[3,6];case 3:return o=i,o?[3,5]:[4,ee({tncConfig:this.tncConfig,storeType:this.getStoreType()})];case 4:return o=c.sent(),[3,6];case 5:ee({tncConfig:this.tncConfig,storeType:this.getStoreType()}).then(function(s){a.tncSchema=s}),c.label=6;case 6:return o&&(this.tncSchema=o,(n=this.storeOnTncSchemaLoaded)===null||n===void 0||n.call(this,o)),this.tncConfig.aid&&this.startPullTask(),[2,this.tncSchema]}})})},e.prototype.startPullTask=function(){var t=this,r=function(){return T(t,void 0,void 0,function(){var n,i,o;return b(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),n=this,[4,ee({tncConfig:this.tncConfig,send_tnc_host_arrays:(i=this.tncSchema)===null||i===void 0?void 0:i.send_tnc_host_arrays,storeType:this.getStoreType()})];case 1:return n.tncSchema=a.sent(),(o=this.storeOnTncSchemaLoaded)===null||o===void 0||o.call(this,this.tncSchema),[3,3];case 2:return a.sent(),[3,3];case 3:return this.status==="pulling"&&(this.pullTaskTimer=setTimeout(r,this.getTncSchemaPullInterval())),[2]}})})};this.status="pulling",this.pullTaskTimer=setTimeout(r,this.getTncSchemaPullInterval())},e.prototype.stopPullTask=function(){this.pullTaskTimer&&clearTimeout(this.pullTaskTimer),this.status="stop"},e.prototype.updateTncConfig=function(t){this.tncConfig=t},e.prototype.getStoreType=function(){return this.tncConfig.storeType||"indexedDB"},e.prototype.getTncSchemaPullInterval=function(){var t,r,n;return!((t=this.tncSchema)===null||t===void 0)&&t.tnc_update_interval?Number(this.tncSchema.tnc_update_interval)*1e3:!((r=this.tncConfig)===null||r===void 0)&&r.alternateIntervals?Number((n=this.tncConfig)===null||n===void 0?void 0:n.alternateIntervals)*1e3:10*1e3},e}();function Ie(e){var t,r,n;return T(this,void 0,void 0,function(){var i,o,a,c,s,u,d,l,h,f,_,y,g,p,w;return b(this,function(S){switch(S.label){case 0:switch(i=e.tncConfig,o=e.send_tnc_host_arrays,a=[],!((t=i.customHosts)===null||t===void 0)&&t.length&&(a=a.concat(i.customHosts)),i.region){case"boe":a=a.concat(yt);break;case"abroad":a=a.concat(bt);break;case"internal":default:a=a.concat(St);break}o!=null&&o.length&&(a=a.concat(o),a=Array.from(new Set(a))),typeof window!="object"?c="node":(s=mt(window.navigator.userAgent),c=s.isAndroid?"android":s.isIos?"ios":s.isMobile?"h5":s.isDesktop?"pc":"web"),u={tnc_js_sdk_version:"0.9.9.9",device_platform:c,aid:i.aid,device_id:(r=i.device_id)!==null&&r!==void 0?r:(n=Rt())===null||n===void 0?void 0:n.toString(),user_id:i.user_id,web_service:i.web_service||""},d=new URLSearchParams,Object.entries(u).map(function(m){var D=m[0],P=m[1];H(P)||d.append(D,P)}),l=d.toString(),f=0,_=a,S.label=1;case 1:if(!(f<_.length))return[3,7];y=_[f],g="".concat(window.location.protocol,"//").concat(y,"/get_domains/v5/?").concat(l),S.label=2;case 2:return S.trys.push([2,5,,6]),[4,fetch(g,{method:"GET",headers:i.customHeaders})];case 3:return p=S.sent(),[4,p.json()];case 4:return w=S.sent(),w.data&&w.message==="success"?(h=w.data,[3,7]):[3,6];case 5:return S.sent(),[3,6];case 6:return f++,[3,1];case 7:if(h)return[2,h];throw new Error("TNC \u62C9\u53D6\u914D\u7F6E\u5931\u8D25")}})})}function ee(e){return T(this,void 0,void 0,function(){var t,r,n,i,o;return b(this,function(a){switch(a.label){case 0:return t=e.tncConfig,r=e.send_tnc_host_arrays,n=e.storeType,i=n===void 0?"localStorage":n,[4,Ie({tncConfig:t,send_tnc_host_arrays:r})];case 1:return o=a.sent(),le({action:"tnc_update_schema",payload:o}),[4,ve({aid:t.multiInstance?t.aid:void 0,tncSchema:o,storeType:i})];case 2:return a.sent(),[2,o]}})})}function wt(e,t){var r,n,i;return T(this,void 0,void 0,function(){var o;return b(this,function(a){switch(a.label){case 0:if(e.swMode==="not-manage")return[2];if(!(((r=t.tnc_js_sdk_control)===null||r===void 0?void 0:r.pwa_enable)===1&&(!e.swMode||e.swMode==="use")))return[3,5];if(!("serviceWorker"in window.navigator&&(window.location.protocol==="https:"||window.location.protocol==="http:"&&window.location.host.indexOf("127.0.0.1")>-1)))return[3,4];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,navigator.serviceWorker.register(e.swPath||"/sw.js",{scope:e.swScope})];case 2:return a.sent(),[3,4];case 3:return a.sent(),[3,4];case 4:return[3,7];case 5:return[4,(i=(n=window.navigator)===null||n===void 0?void 0:n.serviceWorker)===null||i===void 0?void 0:i.getRegistration(e.swScope)];case 6:o=a.sent(),o&&o.unregister(),a.label=7;case 7:return[2]}})})}var Dt=function(e){ht(t,e);function t(r){var n=this,i=r.tncConfig;return n=e.call(this,{tncConfig:i})||this,n.dynamicRoutingManager=new qe({storeType:n.tncConfig.storeType||"indexedDB"}),n.tncSchemaManager=new Ne({tncConfig:n.tncConfig,onTncSchemaLoaded:function(o){var a;(a=n.dynamicRoutingManager)===null||a===void 0||a.setTncSchema(o)}}),n}return t.prototype.init=function(){var r;return T(this,void 0,void 0,function(){var n;return b(this,function(i){switch(i.label){case 0:return[4,this.tncSchemaManager.init()];case 1:return n=i.sent(),n?((r=this.dynamicRoutingManager)===null||r===void 0||r.start(),[4,wt(this.tncConfig,n)]):[2];case 2:return i.sent(),[2]}})})},t.prototype.updateUserId=function(r){e.prototype.updateUserId.call(this,r),this.tncSchemaManager.updateTncConfig(this.tncConfig)},t.prototype.updateCustomHeaders=function(r){e.prototype.updateCustomHeaders.call(this,r),this.tncSchemaManager.updateTncConfig(this.tncConfig)},t}(Ae);function Ct(e){return Array.from(new Set(e))}function Fe(e){return Object.prototype.toString.call(e)==="[object String]"}function Be(e){if(Fe(e))return e;if(e instanceof URL)return e.toString();if(e!=null&&e.url)return e.url}function Pt(e,t){var r,n;return T(this,void 0,void 0,function(){var i,o,a,c,s,u,d;return b(this,function(l){switch(l.label){case 0:return i=Be(e),o=Fe(e),i?o?(a=t,[3,5]):[3,1]:[2,null];case 1:return c=e,s=t,s!=null&&s.body||!((r=c==null?void 0:c.headers)===null||r===void 0)&&r.get("Content-Type")?[4,(n=c==null?void 0:c.clone())===null||n===void 0?void 0:n.blob()]:[3,3];case 2:return d=l.sent(),[3,4];case 3:d=void 0,l.label=4;case 4:u=d,a={method:(s==null?void 0:s.method)||(c==null?void 0:c.method),keepalive:(s==null?void 0:s.keepalive)||(c==null?void 0:c.keepalive),mode:(s==null?void 0:s.mode)||(c==null?void 0:c.mode),redirect:(s==null?void 0:s.redirect)||(c==null?void 0:c.redirect),referrer:(s==null?void 0:s.referrer)||(c==null?void 0:c.referrer),referrerPolicy:(s==null?void 0:s.referrerPolicy)||(c==null?void 0:c.referrerPolicy),signal:(s==null?void 0:s.signal)||(c==null?void 0:c.signal),headers:(s==null?void 0:s.headers)||(c==null?void 0:c.headers),body:u,cache:(s==null?void 0:s.cache)||(c==null?void 0:c.cache),credentials:(s==null?void 0:s.credentials)||(c==null?void 0:c.credentials),integrity:(s==null?void 0:s.integrity)||(c==null?void 0:c.integrity)},l.label=5;case 5:return[2,{url:i,requestInit:a}]}})})}function Ut(e){return T(this,void 0,void 0,function(){var t,r,n,i,o,a,c,s,u,d;return b(this,function(l){switch(l.label){case 0:return t=e.url,r=e.requestInit,n=e.originalRequestParams,i=e._fetch,o=i===void 0?fetch:i,a=e.needHttpStatus,a?[3,12]:(r==null?void 0:r.mode)!=="navigate"?[3,9]:(s=Be(n==null?void 0:n[0]),n&&s===t?[4,o.apply(void 0,n)]:[3,2]);case 1:return c=l.sent(),[3,8];case 2:return l.trys.push([2,4,,8]),[4,o(t,R(R({},r),{mode:"cors"}))];case 3:return c=l.sent(),[3,8];case 4:return u=l.sent(),n?[4,o.apply(void 0,n)]:[3,6];case 5:return c=l.sent(),[3,7];case 6:throw u;case 7:return[3,8];case 8:return[3,11];case 9:return[4,o(t,r)];case 10:c=l.sent(),l.label=11;case 11:return[3,26];case 12:return!(r!=null&&r.mode)||(r==null?void 0:r.mode)==="cors"?[4,o(t,r)]:[3,14];case 13:return c=l.sent(),[3,26];case 14:if((r==null?void 0:r.mode)!=="navigate")return[3,22];l.label=15;case 15:return l.trys.push([15,17,,21]),[4,o(t,R(R({},r),{mode:"cors"}))];case 16:return c=l.sent(),[3,21];case 17:return d=l.sent(),n?[4,o.apply(void 0,n)]:[3,19];case 18:return c=l.sent(),[3,20];case 19:throw d;case 20:return[3,21];case 21:return[3,26];case 22:return l.trys.push([22,24,,26]),[4,o(t,R(R({},r),{mode:"cors"}))];case 23:return c=l.sent(),[3,26];case 24:return l.sent(),[4,o(t,r)];case 25:return c=l.sent(),[3,26];case 26:return[2,c]}})})}function te(e){var t=this,r=e.tncSchema,n=e.storeType,i=n===void 0?"localStorage":n,o=(r||{}).ttnet_dispatch_actions_epoch;if(o){var a={dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_best_routing,key:o}};return i==="localStorage"?B(R(R({},a),{storeType:i})):function(){return T(t,void 0,void 0,function(){return b(this,function(c){switch(c.label){case 0:return[4,B(R(R({},a),{storeType:i}))];case 1:return[2,c.sent()]}})})}()}}function re(e){var t;return T(this,void 0,void 0,function(){var r,n,i,o,a,c,s,u,d,l,h,f;return b(this,function(_){if(r=e.processResults,n=e.responseStatus,i=e.tncSchema,o=e.storeType,a=o===void 0?"localStorage":o,c=(i||{}).ttnet_dispatch_actions_epoch,!i||!c)return[2];for(s=0,u=r;s<u.length;s++){if(d=u[s],l=d.newHost,h=d.actionConfig,!l)return[2];if(h.param.dispatch_strategy===q.bestRouting)return f=h.param.strategy_info,[2,Mt({sign:h.sign,host:l,status:H(n)||!((t=f==null?void 0:f.error_code)===null||t===void 0)&&t.includes(n)?-1:1,tncSchema:i,storeType:a})]}return[2]})})}function Mt(e){var t=this,r=e.sign,n=e.host,i=e.status,o=e.tncSchema,a=e.storeType,c=a===void 0?"localStorage":a,s=(o||{}).ttnet_dispatch_actions_epoch;if(c==="localStorage"){var u=$({dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_best_routing,key:s}}),d=Le({tncSchema:o,bestRoutingData:u,sign:r,host:n,status:i});return $({dbUtilCore:A,operateParams:{operateType:"put",tableName:v.ETableNames.tnc_best_routing,key:s,value:d}}),d}return function(){return T(t,void 0,void 0,function(){var l;return b(this,function(h){switch(h.label){case 0:return[4,A.getDb()];case 1:return l=h.sent(),[2,new Promise(function(f,_){if(!l||!s){_(null);return}var y=l.transaction([v.ETableNames.tnc_best_routing],"readwrite").objectStore(v.ETableNames.tnc_best_routing),g=y.get(s);g.onsuccess=function(){var p=g.result,w=Le({tncSchema:o,bestRoutingData:p,sign:r,host:n,status:i}),S=y.put(w);S.onsuccess=function(){f(w)},S.onerror=function(m){_(m)}},g.onerror=function(p){_(p)}})]}})})}()}function Le(e){var t,r,n=e.tncSchema,i=e.bestRoutingData,o=e.sign,a=e.host,c=e.status,s=(n||{}).ttnet_dispatch_actions_epoch,u=i||{ttnet_dispatch_actions_epoch:s,bestRouting:{}},d=u.bestRouting[o]||{};return!((r=(t=d[a])===null||t===void 0?void 0:t.result)===null||r===void 0)&&r.length||(d[a]={result:[]}),Object.keys(d).forEach(function(l){var h,f,_,y,g=d[l];(!g||!(!((h=g.result)===null||h===void 0)&&h.length))&&(g={result:[]}),l===a?(f=g.result)===null||f===void 0||f.unshift(c):(_=g.result)===null||_===void 0||_.unshift(0),g.result=(y=g.result)===null||y===void 0?void 0:y.slice(0,50),d[l]=g}),u.bestRouting[o]=d,u}function kt(e){var t,r=e.host,n=e.actionConfig,i=e.bestRoutingResult,o=n==null?void 0:n.param.strategy_info,a=o.target_hosts;if((n==null?void 0:n.param.dispatch_strategy)!==q.bestRouting||!o||!(a!=null&&a.length))return r;var c=(t=i==null?void 0:i.bestRouting)===null||t===void 0?void 0:t[n.sign],s=a.map(function(l){var h,f=(h=c==null?void 0:c[l])===null||h===void 0?void 0:h.result,_=o.coefficient;if(!(f!=null&&f.length)||H(_))return[l,0];var y=f.reduce(function(g,p,w){if(!p)return g;var S=p*ne(_,w);return g+S},0);return[l,y]}),u=[],d=-1/0;return s.forEach(function(l){var h=l[0],f=l[1];f>d?(u=[h],d=f):f===d&&u.push(h)}),!(u!=null&&u.length)||(H(o.use_default_host)||o.use_default_host>0)&&u.includes(r)?r:u[0]}function ne(e,t){var r,n,i=(n=ne.Cache[e])===null||n===void 0?void 0:n[t];if(i)return i;var o=Math.floor(t/10),a={x:10*o,y:Math.pow(1-e,o)},c={x:10*(o+1),y:Math.pow(1-e,o+1)},s=(t-a.x)*(c.y-a.y)/(c.x-a.x)+a.y;return ne.Cache[e]=R((r={},r[t]=s,r),ne.Cache[e]),s}ne.Cache={};var ie;function He(e){var t=e.ttnet_dispatch_actions_epoch;return T(this,void 0,void 0,function(){var r;return b(this,function(n){switch(n.label){case 0:return[4,te({tncSchema:{ttnet_dispatch_actions_epoch:t},storeType:"indexedDB"})];case 1:return r=n.sent(),ie=r,[2,r]}})})}var ge=function(e){var t=e.urlObj,r=e.actionConfig,n=e.ttnetDispatchActionData;if(r.action!==O.dispatch&&r.action!==O.web_dispatch||r.param.dispatch_strategy!==q.bestRouting)return{result:[],actionRan:!1};var i=kt({host:t.host,actionConfig:r,bestRoutingResult:n}),o=new URL(t);return i&&(o.host=i),{result:[o],actionRan:!0}},_e=function(){function e(t){var r=this;this.beforeProcess=function(n){var i=n.tncSchema,o=n.storeType;return T(r,void 0,void 0,function(){var a;return b(this,function(c){switch(c.label){case 0:return this.cacheMode!==v.ECacheMode.cache_only?[3,1]:[2,ie];case 1:return this.cacheMode!==v.ECacheMode.cache_first?[3,4]:(a=ie,a?[3,3]:[4,te({tncSchema:i,storeType:o||"indexedDB"})]);case 2:a=c.sent(),c.label=3;case 3:return[2,a];case 4:return[4,te({tncSchema:i,storeType:o||"indexedDB"})];case 5:return[2,c.sent()]}})})},this.getTtnetUrlDispatchData=function(n){var i=n.preGetData;return T(r,void 0,void 0,function(){return b(this,function(o){return[2,i]})})},this.ttnetUrlDispatch=ge,this.cacheMode=t==null?void 0:t.cacheMode}return e.prototype.beforeFetch=function(){return T(this,void 0,void 0,function(){return b(this,function(t){return[2,{needResponseStatus:!0}]})})},e.prototype.afterFetchSuccess=function(t){var r=t.processResults,n=t.tncSchema,i=t.responseStatus,o=t.storeType;return T(this,void 0,void 0,function(){return b(this,function(a){return re({processResults:r,tncSchema:n,responseStatus:i,storeType:o||"indexedDB"}).then(function(c){c&&(ie=c)}),[2]})})},e.prototype.afterFetchError=function(t){var r=t.processResults,n=t.tncSchema,i=t.storeType;return T(this,void 0,void 0,function(){return b(this,function(o){return re({processResults:r,tncSchema:n,responseStatus:null,storeType:i||"indexedDB"}).then(function(a){a&&(ie=a)}),[2]})})},e}(),he;function Ge(e){var t=e.ttnet_dispatch_actions_epoch;return T(this,void 0,void 0,function(){var r;return b(this,function(n){switch(n.label){case 0:return[4,Y({tncSchema:{ttnet_dispatch_actions_epoch:t},storeType:"indexedDB"})];case 1:return r=n.sent(),he=r,[2,r]}})})}function We(e){var t=e.dynamicRoutingStoreData;he=t}var me=function(e){var t,r,n=e.urlObj,i=e.actionConfig,o=e.ttnetDispatchActionData;if(i.action!==O.dispatch&&i.action!==O.web_dispatch||i.param.dispatch_strategy!==q.dynamicRouting)return{result:[],actionRan:!1};var a=(r=(t=o==null?void 0:o.routing)===null||t===void 0?void 0:t[i.sign])===null||r===void 0?void 0:r.result,c=new URL(n);return a&&(c.host=a),{result:[c],actionRan:!0}},ye=function(){function e(t){var r=this;this.beforeProcess=function(n){var i=n.tncSchema,o=n.storeType;return T(r,void 0,void 0,function(){var a;return b(this,function(c){switch(c.label){case 0:return this.cacheMode!==v.ECacheMode.cache_only?[3,1]:[2,he];case 1:return this.cacheMode!==v.ECacheMode.cache_first?[3,4]:(a=he,a?[3,3]:[4,Y({tncSchema:i,storeType:o||"indexedDB"})]);case 2:a=c.sent(),c.label=3;case 3:return[2,a];case 4:return[4,Y({tncSchema:i,storeType:o||"indexedDB"})];case 5:return[2,c.sent()]}})})},this.getTtnetUrlDispatchData=function(n){var i=n.preGetData;return T(r,void 0,void 0,function(){return b(this,function(o){return[2,i]})})},this.ttnetUrlDispatch=me,this.cacheMode=t==null?void 0:t.cacheMode}return e}();function oe(e){var t=this,r=e.tncSchema,n=e.storeType,i=n===void 0?"localStorage":n,o=(r||{}).ttnet_dispatch_actions_epoch;if(o){var a={dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_elimination,key:o}};return i==="localStorage"?B(R(R({},a),{storeType:i})):function(){return T(t,void 0,void 0,function(){return b(this,function(c){switch(c.label){case 0:return[4,B(R(R({},a),{storeType:i}))];case 1:return[2,c.sent()]}})})}()}}function ae(e){var t;return T(this,void 0,void 0,function(){var r,n,i,o,a,c,s,u,d,l,h,f;return b(this,function(_){switch(_.label){case 0:if(r=e.processResults,n=e.responseStatus,i=e.tncSchema,o=e.storeType,a=o===void 0?"localStorage":o,c=(i||{}).ttnet_dispatch_actions_epoch,!i||!c)return[2];s=0,u=r,_.label=1;case 1:return s<u.length?(d=u[s],l=d.newHost,h=d.actionConfig,l?h.param.dispatch_strategy!==q.elimination?[3,3]:(f=h.param.strategy_info,[4,Et({sign:h.sign,host:l,status:H(n)||!((t=f==null?void 0:f.error_code)===null||t===void 0)&&t.includes(n)?-1:1,least_sample:f==null?void 0:f.least_sample,tncSchema:i,storeType:a})]):[2]):[3,4];case 2:return[2,_.sent()];case 3:return s++,[3,1];case 4:return[2]}})})}function Et(e){var t=this,r=e.sign,n=e.host,i=e.status,o=e.least_sample,a=e.tncSchema,c=e.storeType,s=c===void 0?"localStorage":c,u=(a||{}).ttnet_dispatch_actions_epoch;if(s==="localStorage"){var d=$({dbUtilCore:A,operateParams:{operateType:"get",tableName:v.ETableNames.tnc_elimination,key:u}}),l=Xe({ttnet_dispatch_actions_epoch:u,eliminationData:d,sign:r,host:n,status:i,least_sample:o});return $({dbUtilCore:A,operateParams:{operateType:"put",tableName:v.ETableNames.tnc_elimination,key:u,value:l}}),l}return function(){return T(t,void 0,void 0,function(){var h;return b(this,function(f){switch(f.label){case 0:return[4,A.getDb()];case 1:return h=f.sent(),[2,new Promise(function(_,y){if(!h||!u){y(null);return}var g=h.transaction([v.ETableNames.tnc_elimination],"readwrite").objectStore(v.ETableNames.tnc_elimination),p=g.get(u);p.onsuccess=function(){var w=p.result||{ttnet_dispatch_actions_epoch:u,elimination:{}},S=Xe({ttnet_dispatch_actions_epoch:u,eliminationData:w,sign:r,host:n,status:i,least_sample:o}),m=g.put(S);m.onsuccess=function(){_(S)},m.onerror=function(D){y(D)}},p.onerror=function(w){y(w)}})]}})})}()}function Xe(e){var t=e.ttnet_dispatch_actions_epoch,r=e.eliminationData,n=e.sign,i=e.host,o=e.status,a=e.least_sample,c=r||{ttnet_dispatch_actions_epoch:t,elimination:{}},s=c.elimination[n]||{hosts:{}};if(s.hosts||(s.hosts={}),o===-1){var u=s.hosts[i]||{};u.failSamples=(u.failSamples||0)+1,u.failSamples>=(a||0)&&(u.forbidTime=Date.now()),s.hosts[i]=u}else o===1&&(s.usingHost=i,delete s.hosts[i]);return c.elimination[n]=s,c}function Ot(e){return e[Math.floor(Math.random()*e.length)]}function qt(e){var t,r,n,i=e.host,o=e.actionConfig,a=e.eliminationResult,c=(t=o==null?void 0:o.param)===null||t===void 0?void 0:t.strategy_info;if((o==null?void 0:o.param.dispatch_strategy)!==q.elimination||!c)return i;var s=(r=c.target_hosts)===null||r===void 0?void 0:r.filter(function(d){var l,h,f=(h=(l=a==null?void 0:a.elimination[o.sign])===null||l===void 0?void 0:l.hosts)===null||h===void 0?void 0:h[d];return!f||!f.failSamples||!f.forbidTime?!0:!(f.failSamples>=(c.least_sample||0)&&f.forbidTime+(c.forbid_duration||0)*1e3>=Date.now())});if(!(s!=null&&s.length)||(H(c.use_default_host)||c.use_default_host>0)&&s.includes(i))return i;var u=(n=a==null?void 0:a.elimination[o.sign])===null||n===void 0?void 0:n.usingHost;return u&&s.includes(u)?u:!H(c.random_select)&&c.random_select>0?Ot(s):s[0]}var ce;function Ve(e){var t=e.ttnet_dispatch_actions_epoch;return T(this,void 0,void 0,function(){var r;return b(this,function(n){switch(n.label){case 0:return[4,oe({tncSchema:{ttnet_dispatch_actions_epoch:t},storeType:"indexedDB"})];case 1:return r=n.sent(),ce=r,[2,r]}})})}var be=function(e){var t=e.urlObj,r=e.actionConfig,n=e.ttnetDispatchActionData;if(r.action!==O.dispatch&&r.action!==O.web_dispatch||r.param.dispatch_strategy!==q.elimination)return{result:[],actionRan:!1};var i=qt({host:t.host,actionConfig:r,eliminationResult:n}),o=new URL(t);return i&&(o.host=i),{result:[o],actionRan:!0}},Se=function(){function e(t){var r=this;this.getTtnetUrlDispatchData=function(n){var i=n.preGetData;return T(r,void 0,void 0,function(){return b(this,function(o){return[2,i]})})},this.ttnetUrlDispatch=be,this.cacheMode=t==null?void 0:t.cacheMode}return e.prototype.beforeProcess=function(t){var r=t.tncSchema,n=t.storeType;return T(this,void 0,void 0,function(){var i;return b(this,function(o){switch(o.label){case 0:return this.cacheMode!==v.ECacheMode.cache_only?[3,1]:[2,ce];case 1:return this.cacheMode!==v.ECacheMode.cache_first?[3,4]:(i=ce,i?[3,3]:[4,oe({tncSchema:r,storeType:n||"indexedDB"})]);case 2:i=o.sent(),o.label=3;case 3:return[2,i];case 4:return[4,oe({tncSchema:r,storeType:n||"indexedDB"})];case 5:return[2,o.sent()]}})})},e.prototype.beforeFetch=function(){return T(this,void 0,void 0,function(){return b(this,function(t){return[2,{needResponseStatus:!0}]})})},e.prototype.afterFetchSuccess=function(t){var r=t.processResults,n=t.tncSchema,i=t.responseStatus,o=t.storeType;return T(this,void 0,void 0,function(){return b(this,function(a){return ae({processResults:r,tncSchema:n,responseStatus:i,storeType:o||"indexedDB"}).then(function(c){c&&(ce=c)}),[2]})})},e.prototype.afterFetchError=function(t){var r=t.processResults,n=t.tncSchema,i=t.storeType;return T(this,void 0,void 0,function(){return b(this,function(o){return ae({processResults:r,tncSchema:n,responseStatus:null,storeType:i||"indexedDB"}).then(function(a){a&&(ce=a)}),[2]})})},e}();function $e(e){var t,r,n=e.urlObj,i=e.matchActionResult,o=e.referrer,a=e.processParams,c=new URL(n.toString()),s="";try{o&&(s=new URL(o).host)}catch(u){}if(a!=null&&a.scheme_replace&&(c.protocol=a.scheme_replace.indexOf(":")>-1?a.scheme_replace:"".concat(a.scheme_replace,":")),a!=null&&a.host_replace&&!(a.host_replace.includes("${currentHost}")&&!s)&&(c.host=a.host_replace.replace("${currentHost}",s)),(a==null?void 0:a.drop)==1&&(c.host="127.0.0.1"),a!=null&&a.path_replace&&(c.pathname=a==null?void 0:a.path_replace),i.fullUrlGroupMatched&&((t=a==null?void 0:a.full_url_group)===null||t===void 0?void 0:t.length)===1&&a.replace&&!(a.replace.includes("${currentHost}")&&!s))try{c=new URL(c.toString().replace(new RegExp(a.full_url_group[0]),a.replace.replace("${currentHost}",s)))}catch(u){}if(i.patternGroupMatched&&((r=a==null?void 0:a.pattern_group)===null||r===void 0?void 0:r.length)===1&&a.pattern_replace)try{c.pathname=c.pathname.replace(new RegExp(a.pattern_group[0]),a.pattern_replace)}catch(u){}return c}function At(e){var t=e.urlObj,r=e.matchActionResult,n=e.referrer,i=e.actionConfig,o=i==null?void 0:i.param.strategy_info;if((i==null?void 0:i.param.dispatch_strategy)!==q.orderTry||!(o!=null&&o.targets.length))return[t];var a=o.use_default_host===0?o.targets:o.targets.sort(function(c,s){return!c.host_replace||c.host_replace===t.host?-1:!s.host_replace||s.host_replace===t.host?1:0});return a.map(function(c){return $e({urlObj:t,matchActionResult:r,referrer:n,processParams:R({full_url_group:i.param.full_url_group,pattern_group:i.param.pattern_group},c)})})}function jt(e){for(var t,r=e.processResults,n=r.length-1;n>=0;n--){var i=r[n].actionConfig;if((i.action===O.dispatch||i.action===O.web_dispatch)&&i.param.dispatch_strategy===q.orderTry)return(t=i.param.strategy_info)===null||t===void 0?void 0:t.error_code}}var Ke=function(e){var t=e.urlObj,r=e.matchActionResult,n=e.referrer,i=e.actionConfig;if(i.action!==O.dispatch&&i.action!==O.web_dispatch||i.param.dispatch_strategy!==q.orderTry)return{result:[],actionRan:!1};var o=At({urlObj:t,matchActionResult:r,referrer:n,actionConfig:i});return{result:o,actionRan:!0}},ze={ttnetUrlDispatch:Ke,beforeFetch:function(e){var t=e.processResults;return T(void 0,void 0,void 0,function(){return b(this,function(r){return[2,{retryErrorResponseStatuses:jt({processResults:t})}]})})}},Je=function(e){var t=e.urlObj,r=e.actionConfig;if(r.action!==O.dispatch&&r.action!==O.web_dispatch||r.param.dispatch_strategy!==q.baseReplace)return{result:[],actionRan:!1};var n=r.param.strategy_info,i=new URL(t),o=n==null?void 0:n[t.host];return o&&(i.host=o),{result:[i],actionRan:!0}},Ye={ttnetUrlDispatch:Je},xe=function(e){var t=e.urlObj,r=e.matchActionResult,n=e.referrer,i=e.actionConfig;if(i.action!==O.tc&&i.action!==O.web_tc)return{result:[],actionRan:!1};var o=$e({urlObj:t,matchActionResult:r,referrer:n,processParams:i.param});return{result:[o],actionRan:!0}},Qe={ttnetUrlDispatch:xe};function Ze(){if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global;if(typeof globalThis!="undefined")return globalThis}function Nt(e){try{var t=new RegExp("^"+e.matchTarget.replace(/\-/g,"\\-").replace(/\./g,"\\.").replace(/\*/g,"[^\\.]*")+"$");return t.test(e.host)}catch(r){return!1}}function et(){var e=Ze();return!!e.registration&&!!e.clients}function tt(e){var t,r,n,i,o,a,c,s,u,d,l,h,f,_,y,g=e.urlObj,p=e.actionConfig,w=e.referrer,S=e.ignore_referrer,m=!1;if(!(!((r=(t=p.param)===null||t===void 0?void 0:t.host_group)===null||r===void 0)&&r.length))m=!0;else for(var D=0,P=p.param.host_group;D<P.length;D++){var C=P[D];if(C===g.host||C==="*"||C.includes("*")&&Nt({host:g.host,matchTarget:C})){m=!0;break}}var U=!1;if(!(!((i=(n=p.param)===null||n===void 0?void 0:n.equal_group)===null||i===void 0)&&i.length))U=!0;else for(var I=0,Q=p.param.equal_group;I<Q.length;I++){var z=Q[I];if(z===g.pathname){U=!0;break}}var G=!1;if(!(!((a=(o=p==null?void 0:p.param)===null||o===void 0?void 0:o.contain_group)===null||a===void 0)&&a.length))G=!0;else for(var W=0,Z=p.param.contain_group;W<Z.length;W++){var z=Z[W];if(g.pathname.indexOf(z)>-1){G=!0;break}}var J=!1;if(!(!((s=(c=p==null?void 0:p.param)===null||c===void 0?void 0:c.pattern_group)===null||s===void 0)&&s.length))J=!0;else for(var L=0,X=p.param.pattern_group;L<X.length;L++){var j=X[L],F=new RegExp(j);if(F.test(g.pathname)){J=!0;break}}var M=!1;if(!(!((d=(u=p==null?void 0:p.param)===null||u===void 0?void 0:u.full_url_group)===null||d===void 0)&&d.length))M=!0;else for(var k=0,E=p.param.full_url_group;k<E.length;k++){var j=E[k],F=new RegExp(j);if(F.test(g.toString())){M=!0;break}}var N=!1;if(S||!(!((l=p==null?void 0:p.param)===null||l===void 0)&&l.referrer_group))N=!0;else if(!w)N=!1;else for(var Ce=0,ut=p.param.referrer_group;Ce<ut.length;Ce++){var j=ut[Ce],F=new RegExp(j);if(w&&F.test(w)){N=!0;break}}var se=!1;if(S||et()||!(!((h=p==null?void 0:p.param)===null||h===void 0)&&h.proxy_referrer_group))se=!0;else if(!w)se=!1;else for(var Pe=0,lt=p.param.proxy_referrer_group;Pe<lt.length;Pe++){var j=lt[Pe],F=new RegExp(j);if(w&&F.test(w)){se=!0;break}}var ue=!1;if(!et())ue=!0;else{var Xt=(_=(f=Ze())===null||f===void 0?void 0:f.registration)===null||_===void 0?void 0:_.scope;if(!(!((y=p==null?void 0:p.param)===null||y===void 0)&&y.sw_scope_group))ue=!0;else if(!Xt)ue=!1;else for(var Ue=0,dt=p.param.sw_scope_group;Ue<dt.length;Ue++){var j=dt[Ue],F=new RegExp(j);if(w&&F.test(w)){ue=!0;break}}}var Vt=m&&U&&G&&J&&M&&N&&se&&ue;return{matched:Vt,hostMatched:m,equalGroupMatched:U,containGroupMatched:G,patternGroupMatched:J,fullUrlGroupMatched:M,referrerMatched:N,proxyReferrerGroupMatched:se}}function Te(e){var t;try{var r=e.url,n=e.tncSchema,i=e.referrer,o=e.ttnetUrlDispatches,a=e.ttnetUrlDispatchesData;if(!n||n.ttnet_url_dispatcher_enabled!==1||!(!((t=n.ttnet_dispatch_actions)===null||t===void 0)&&t.length))return[{newUrl:e.url,processResults:[]}];var c=rt(n),s=nt({url:r,referrer:i});return Re({step:0,pastProcessResults:[],sortedActionsList:c||[],urlObj:s,referrer:i,ttnetUrlDispatches:o,ttnetUrlDispatchesData:a})}catch(u){return[{newUrl:e.url,processResults:[]}]}}function rt(e){var t,r,n;return(n=(r=(t=e==null?void 0:e.ttnet_dispatch_actions)===null||t===void 0?void 0:t.filter(function(i){return!!i.act_priority}))===null||r===void 0?void 0:r.map(function(i){return R(R({},i),{act_priority:Number(i.act_priority),set_req_priority:H(i.set_req_priority)?i.set_req_priority:Number(i.set_req_priority)})}))===null||n===void 0?void 0:n.sort(function(i,o){return i.act_priority-o.act_priority})}function nt(e){var t=e.url,r=e.referrer;if(!r)return new URL(t);var n=new URL(r);return t.includes("://")?new URL(t):t.startsWith("//")?new URL(n.protocol+t):t.startsWith("/")?new URL(n.origin+t):new URL(n.origin+"/"+t)}function Re(e){var t=e.step,r=e.pastProcessResults,n=e.sortedActionsList,i=e.urlObj,o=e.referrer,a=e.ttnetUrlDispatches,c=e.ttnetUrlDispatchesData;if(H(t)||t<0)return[{newUrl:i.toString(),processResults:r}];var s=n[t];if(!s)return[{newUrl:i.toString(),processResults:r}];var u=It({urlObj:i,actionConfig:s,referrer:o,ttnetUrlDispatches:a,ttnetUrlDispatchesData:c}),d=[];return u.forEach(function(l){var h=l.newUrlObj,f=l.matched,_=l.processResult,y=V([],r,!0);f&&_&&y.push(_),f&&s.set_req_priority?d.push.apply(d,Re({step:n.findIndex(function(g){return g.act_priority===s.set_req_priority}),pastProcessResults:y,sortedActionsList:n,urlObj:h,referrer:o,ttnetUrlDispatches:a,ttnetUrlDispatchesData:c})):d.push.apply(d,Re({step:t+1,pastProcessResults:y,sortedActionsList:n,urlObj:h,referrer:o,ttnetUrlDispatches:a,ttnetUrlDispatchesData:c}))}),d}function It(e){var t=e.urlObj,r=e.actionConfig,n=e.referrer,i=e.ttnetUrlDispatches,o=e.ttnetUrlDispatchesData,a=tt({urlObj:t,actionConfig:r,referrer:n}),c=[{newUrlObj:t,matched:!!a.matched,processResult:{newUrl:t.toString(),newHost:t.host,actionConfig:r}}];if(!a.matched)return c;for(var s=0;s<((i==null?void 0:i.length)||0);s++){var u=i==null?void 0:i[s];if(u){var d=u({ttnetDispatchActionData:o[s],urlObj:t,matchActionResult:a,referrer:n,actionConfig:r}),l=d.result,h=d.actionRan;if(h)return l.map(function(f){return{newUrlObj:f,matched:!!a.matched,processResult:{newUrl:f.toString(),newHost:f.host,actionConfig:r}}})}}return c}function it(e){var t,r=e.url,n=e.schema,i=e.referrer,o=e.ignore_referrer;if(!n||n.ttnet_url_dispatcher_enabled!==1||!(!((t=n.ttnet_dispatch_actions)===null||t===void 0)&&t.length))return!1;for(var a=rt(n),c=nt({url:r,referrer:i}),s=0,u=a||[];s<u.length;s++){var d=u[s],l=tt({ignore_referrer:o,urlObj:c,actionConfig:d,referrer:i}).matched;if(l)return!0}return!1}function Ft(e){var t=e.url,r=e.tncSchema,n={};if(!(r!=null&&r.web_request_control))return n;var i;try{i=new URL(t)}catch(p){return n}if(Array.isArray(r.web_request_control.mode_change))for(var o=0,a=r.web_request_control.mode_change;o<a.length;o++){var c=a[o];if(c.mode){var s=void 0;if(c.host_group&&Array.isArray(c.host_group)){for(var u=0,d=c.host_group;u<d.length;u++){var l=d[u];if(l==="*"||l===i.host){s=!0;break}}s===void 0&&(s=!1)}else s=!0;if(s){n.mode=c.mode;break}}}if(Array.isArray(r.web_request_control.credentials_change))for(var h=0,f=r.web_request_control.credentials_change;h<f.length;h++){var _=f[h];if(_.credentials){var s=void 0;if(_.host_group&&Array.isArray(_.host_group)){for(var y=0,g=_.host_group;y<g.length;y++){var l=g[y];if(l==="*"||l===i.host){s=!0;break}}s===void 0&&(s=!1)}else s=!0;if(s){n.credentials=_.credentials;break}}}return n}var ot={beforeFetchModifyRequest:function(e){var t=e.newUrl,r=e.tncSchema,n=e.requestInit;return T(void 0,void 0,void 0,function(){var i,o,a,c;return b(this,function(s){return i=Ft({url:t,tncSchema:r}),o=i.mode,a=i.credentials,c=R({},n),o&&(c.mode=o),a&&(c.credentials=a),[2,{newRequestInit:c}]})})}};function we(e){var t=e.plugins;return function(n){return T(this,void 0,void 0,function(){var i,o,a,c,s,u,d,l,h,f,_,y,g,p,w;return b(this,function(S){switch(S.label){case 0:return i=n.requestInput,o=n.requestInit,a=n.originalRequestParams,c=n._fetch,s=n.referrer,u=n.tncSchema,d=n.onBeforeRequestSend,l=function(){for(var m=[],D=0;D<arguments.length;D++)m[D]=arguments[D];return d==null||d(),c.apply(void 0,m)},!u||!u.ttnet_url_dispatcher_enabled||!(t!=null&&t.length)?(d==null||d(),[4,l(i,o)]):[3,2];case 1:return[2,S.sent()];case 2:return S.trys.push([2,4,,6]),[4,Pt(i,o)];case 3:return h=S.sent(),[3,6];case 4:return S.sent(),[4,l(i,o)];case 5:return[2,S.sent()];case 6:return!h||!h.url?[4,l(i,o)]:[3,8];case 7:return[2,S.sent()];case 8:return S.trys.push([8,10,,12]),[4,Promise.all(t.map(function(m){var D;return(D=m.beforeProcess)===null||D===void 0?void 0:D.call(m,{tncSchema:u,storeType:n.storeType})}))];case 9:return f=S.sent(),[3,12];case 10:return S.sent(),[4,l(i,o)];case 11:return[2,S.sent()];case 12:return S.trys.push([12,14,,16]),[4,Promise.all(t.map(function(m,D){var P;return(P=m.getTtnetUrlDispatchData)===null||P===void 0?void 0:P.call(m,{preGetData:f[D]})}))];case 13:return _=S.sent(),[3,16];case 14:return S.sent(),[4,l(i,o)];case 15:return[2,S.sent()];case 16:return S.trys.push([16,17,,19]),y=Te({url:h.url,tncSchema:u,referrer:s,ttnetUrlDispatches:t.map(function(m){return m.ttnetUrlDispatch}),ttnetUrlDispatchesData:t.map(function(m,D){return _[D]})}),[3,19];case 17:return S.sent(),[4,l(i,o)];case 18:return[2,S.sent()];case 19:g=function(m){var D,P,C,U,I,Q,z,G,W,Z,J,L,X,j,F;return b(this,function(M){switch(M.label){case 0:if(D=y[m],P=D.newUrl,C=D.processResults,!C.length)return[2,"continue"];U=void 0,M.label=1;case 1:M.trys.push([1,6,,8]),U=h.requestInit,I=0,M.label=2;case 2:return I<t.length?(Q=t[I],Q.beforeFetchModifyRequest?[4,Q.beforeFetchModifyRequest({newUrl:P,tncSchema:u,requestInit:U,processResults:C,preGetData:f[I]})]:[3,4]):[3,5];case 3:z=M.sent().newRequestInit,z&&(U=z),M.label=4;case 4:return I++,[3,2];case 5:return[3,8];case 6:return M.sent(),G={},[4,l(i,o)];case 7:return[2,(G.value=M.sent(),G)];case 8:W=void 0,M.label=9;case 9:return M.trys.push([9,11,,13]),[4,Promise.all(t.map(function(k,E){var N;return(N=k.beforeFetch)===null||N===void 0?void 0:N.call(k,{processResults:C,preGetData:f[E],originalUrl:h==null?void 0:h.url,dispatchedUrl:P,sequenceNumber:m})}))];case 10:return W=M.sent(),[3,13];case 11:return M.sent(),Z={},[4,l(i,o)];case 12:return[2,(Z.value=M.sent(),Z)];case 13:J=W.some(function(k){return k==null?void 0:k.needResponseStatus}),L=W.reduce(function(k,E){var N;return!((N=E==null?void 0:E.retryErrorResponseStatuses)===null||N===void 0)&&N.length?Ct(V(V([],k,!0),E.retryErrorResponseStatuses,!0)):k},[]),j=void 0,M.label=14;case 14:return M.trys.push([14,16,,17]),[4,Ut({url:P,requestInit:U,originalRequestParams:a,_fetch:l,needHttpStatus:J||!!(L!=null&&L.length)})];case 15:return X=M.sent(),[3,17];case 16:return F=M.sent(),j=F,[3,17];case 17:if(!X||j){try{Promise.all(t.map(function(k){var E;return(E=k.afterFetchError)===null||E===void 0?void 0:E.call(k,{processResults:C,tncSchema:u,storeType:n.storeType})}))}catch(k){}if(m<y.length-1)return[2,"continue"];throw j}try{t.map(function(k){var E;return(E=k.afterFetchSuccess)===null||E===void 0?void 0:E.call(k,{processResults:C,tncSchema:u,responseStatus:X.status,storeType:n.storeType})})}catch(k){}if(L!=null&&L.includes(X.status)){if(m<y.length-1)return[2,"continue"];throw j}return[2,{value:X}]}})},p=0,S.label=20;case 20:return p<y.length?[5,g(p)]:[3,23];case 21:if(w=S.sent(),typeof w=="object")return[2,w.value];S.label=22;case 22:return p++,[3,20];case 23:return[4,l(i,o)];case 24:return[2,S.sent()]}})})}}var at=we({plugins:[Ye,Qe,new _e,new ye,new Se,ze,ot]});function Bt(e){var t=this,r=e.tncManager,n=e.onBeforeRequestSend,i=new Proxy(fetch,{apply:function(o,a,c){return function(){return T(t,void 0,void 0,function(){var s,u,d,l,h,f,_;return b(this,function(y){return n&&(s=Date.now(),u=(h=performance==null?void 0:performance.mark("request_start"))===null||h===void 0?void 0:h.startTime),d=r.tncSchemaManager.tncSchema,!d&&e.tncManager.tncConfig.storeType==="localStorage"&&(d=K({storeType:"localStorage",aid:e.tncManager.tncConfig.multiInstance?e.tncManager.tncConfig.aid:void 0})),((_=(f=navigator.serviceWorker)===null||f===void 0?void 0:f.controller)===null||_===void 0?void 0:_.state)==="activated"||!d?[2,o(c[0],c[1])]:(l=window.location.href,[2,at({requestInput:c[0],requestInit:c[1],_fetch:o,referrer:l,tncSchema:d,storeType:r.tncConfig.storeType,onBeforeRequestSend:n?function(){var g;n({tncStartTime:s,tncEndTime:Date.now(),tncDuration:((g=performance==null?void 0:performance.mark("fetch_end"))===null||g===void 0?void 0:g.startTime)-u})}:void 0})])})})}()}});window.fetch=i}function ct(e){var t=e.url,r=e.referrer,n=e.tncSchema,i=e.ttnetUrlDispatches,o=e.ttnetUrlDispatchesData,a=Te({url:t,tncSchema:n,referrer:r,ttnetUrlDispatches:i,ttnetUrlDispatchesData:o});return a}function st(e){var t=e.ttnetUrlDispatchesData,r=ft(e,["ttnetUrlDispatchesData"]),n=t||{},i=n.bestRoutingDispatchData,o=n.dynamicRoutingDispatchData,a=n.eliminationDispatchData;return ct(R(R({},r),{ttnetUrlDispatches:[Je,ge,me,be,Ke,xe],ttnetUrlDispatchesData:[null,i,o,a,null,null]}))}function Lt(e){var t=e.tncManager,r=e.onBeforeRequestSend,n=new Proxy(window.XMLHttpRequest.prototype.open,{apply:function(o,a,c){var s,u,d,l,h,f,_,y;r&&(_=Date.now(),y=(s=performance==null?void 0:performance.mark("xhr_start"))===null||s===void 0?void 0:s.startTime);try{var g=e.tncManager.tncSchemaManager.tncSchema;if(!g&&e.tncManager.tncConfig.storeType==="localStorage"&&(g=K({storeType:"localStorage",aid:e.tncManager.tncConfig.multiInstance?e.tncManager.tncConfig.aid:void 0})),((d=(u=navigator.serviceWorker)===null||u===void 0?void 0:u.controller)===null||d===void 0?void 0:d.state)==="activated"||!g||!g.ttnet_url_dispatcher_enabled)return r&&r({tncStartTime:_,tncEndTime:Date.now(),tncDuration:((l=performance==null?void 0:performance.mark("xhr_end"))===null||l===void 0?void 0:l.startTime)-y}),Reflect.apply(o,a,V([],c,!0));var p=void 0,w=void 0,S=void 0;g&&t.tncConfig.storeType==="localStorage"&&(p=Y({tncSchema:g,storeType:"localStorage"}),w=te({tncSchema:g,storeType:"localStorage"}),S=oe({tncSchema:g,storeType:"localStorage"}));var m=c[1],D=st({url:m,tncSchema:g,referrer:window.location.href,ttnetUrlDispatchesData:{dynamicRoutingDispatchData:p,bestRoutingDispatchData:w,eliminationDispatchData:S}});return a._tnc_tncSchema=g,a._tnc_url_process_result=D,c[1]=D[0].newUrl,r&&r({tncStartTime:_,tncEndTime:Date.now(),tncDuration:((h=performance==null?void 0:performance.mark("xhr_end"))===null||h===void 0?void 0:h.startTime)-y}),Reflect.apply(o,a,V([],c,!0))}catch(P){return r&&r({tncStartTime:_,tncEndTime:Date.now(),tncDuration:((f=performance==null?void 0:performance.mark("xhr_end"))===null||f===void 0?void 0:f.startTime)-y}),Reflect.apply(o,a,V([],c,!0))}}});window.XMLHttpRequest.prototype.open=n;var i=new Proxy(window.XMLHttpRequest,{construct:function(o){var a=new o;return a.addEventListener("load",function(){if(t.tncConfig.storeType==="localStorage"&&a._tnc_tncSchema&&a._tnc_url_process_result){var c=a._tnc_tncSchema;a._tnc_url_process_result.forEach(function(s){re({storeType:"localStorage",tncSchema:c,processResults:s.processResults,responseStatus:a.status}),ae({storeType:"localStorage",tncSchema:c,processResults:s.processResults,responseStatus:a.status})})}}),a.addEventListener("error",function(){if(t.tncConfig.storeType==="localStorage"&&a._tnc_tncSchema&&a._tnc_url_process_result){var c=a._tnc_tncSchema;a._tnc_url_process_result.forEach(function(s){re({storeType:"localStorage",tncSchema:c,processResults:s.processResults,responseStatus:null}),ae({storeType:"localStorage",tncSchema:c,processResults:s.processResults,responseStatus:null})})}}),a}});window.XMLHttpRequest=i}var Ht=function(){function e(t){var r=this;this.onBeforeRequest=t==null?void 0:t.onBeforeRequest,this.onBeforeRequest&&(this.beforeFetch=function(n){return T(r,void 0,void 0,function(){var i;return b(this,function(o){return(i=this.onBeforeRequest)===null||i===void 0||i.call(this,{originalUrl:n.originalUrl,dispatchedUrl:n.dispatchedUrl,sequenceNumber:n.sequenceNumber}),[2,{}]})})})}return e}(),x=self,Gt=function(){function e(t){var r=this;this.cacheMode=t==null?void 0:t.cacheMode,this.tncFetch=De({tncServiceWorkerManager:this,normalFetch:fetch}),((t==null?void 0:t.cacheMode)===v.ECacheMode.cache_only||(t==null?void 0:t.cacheMode)===v.ECacheMode.cache_first)&&(x.addEventListener("message",function(n){var i=n.data;i.action===Ee&&(r.tncSchemaCache=i.payload)}),x.addEventListener("message",function(n){var i=n.data;i.action===Oe&&We({dynamicRoutingStoreData:i.payload})}),function(){return T(r,void 0,void 0,function(){var n;return b(this,function(i){switch(i.label){case 0:return[4,this.getTncSchemaFromStoreToCache()];case 1:return n=i.sent(),n?(Ve({ttnet_dispatch_actions_epoch:n.ttnet_dispatch_actions_epoch}),He({ttnet_dispatch_actions_epoch:n.ttnet_dispatch_actions_epoch}),Ge({ttnet_dispatch_actions_epoch:n.ttnet_dispatch_actions_epoch}),[2]):[2]}})})}()),x.addEventListener("activate",function(n){n.waitUntil(function(){return T(r,void 0,void 0,function(){return b(this,function(i){switch(i.label){case 0:return[4,A.init()];case 1:return i.sent(),[2]}})})}())})}return e.prototype.getTncSchemaFromCache=function(){return this.tncSchemaCache},e.prototype.getTncSchemaFromStoreToCache=function(){return T(this,void 0,void 0,function(){var t;return b(this,function(r){switch(r.label){case 0:return[4,K({storeType:"indexedDB"})];case 1:return t=r.sent(),this.tncSchemaCache=t,[2,t]}})})},e.prototype.listenFetchEvent=function(){var t=this;x.addEventListener("fetch",function(r){var n;if(t.cacheMode===v.ECacheMode.cache_only){if(n=t.getTncSchemaFromCache(),!n)return}else t.cacheMode===v.ECacheMode.cache_first&&(n=t.getTncSchemaFromCache());n&&!it({url:r.request.url,schema:n,ignore_referrer:!0})||r.respondWith(function(){return T(t,void 0,void 0,function(){return b(this,function(i){return fetch.isTncProxyFetch?[2,fetch(r.request,void 0,r)]:[2,this.tncFetch(r.request,void 0,r)]})})}())})},e}();function De(e){var t=this,r,n=e.normalFetch,i=e.tncServiceWorkerManager,o=we({plugins:[Ye,Qe,new _e({cacheMode:i.cacheMode}),new ye({cacheMode:i.cacheMode}),new Se({cacheMode:i.cacheMode}),ze,ot,new Ht((r=e.pluginOptions)===null||r===void 0?void 0:r.requestEventPlugin)]});return new Proxy(n,{apply:function(a,c,s){return function(){return T(t,void 0,void 0,function(){var u,d,l,h,f,_,y,g,p,m,w,S,m,D,P;return b(this,function(C){switch(C.label){case 0:return u=s||[],d=u[0],l=u[1],h=u[2],i.cacheMode!==v.ECacheMode.cache_only?[3,1]:(f=i.getTncSchemaFromCache(),[3,9]);case 1:if(i.cacheMode!==v.ECacheMode.cache_first)return[3,6];if(f=i.getTncSchemaFromCache(),f)return[3,5];C.label=2;case 2:return C.trys.push([2,4,,5]),[4,K({storeType:"indexedDB"})];case 3:return f=C.sent(),[3,5];case 4:return C.sent(),[2,a(d,l)];case 5:return[3,9];case 6:return C.trys.push([6,8,,9]),[4,K({storeType:"indexedDB"})];case 7:return f=C.sent(),[3,9];case 8:return C.sent(),[2,a(d,l)];case 9:if(!f)return[2,a(d,l)];if(!(!((D=f.ttnet_dispatch_actions)===null||D===void 0)&&D.some(function(U){return U.param.referrer_group})))return[3,16];_=(l==null?void 0:l.referrer)||((P=d)===null||P===void 0?void 0:P.referrer),C.label=10;case 10:return C.trys.push([10,15,,16]),!_||!(new URL(_).pathname.length>1)?(y=x.clients,g=h==null?void 0:h.clientId,g?"get"in y?[4,y.get(g)]:[3,12]:[3,14]):[3,14];case 11:return p=C.sent(),m=p==null?void 0:p.url,_=m||"",[3,14];case 12:return[4,y.matchAll({type:"window"})];case 13:w=C.sent(),S=w.filter(function(U){return U.id===g}),S.length>0&&(m=S[0].url,_=m||""),C.label=14;case 14:return[3,16];case 15:return C.sent(),[3,16];case 16:return[2,o({requestInput:d,originalRequestParams:[d,l],_fetch:a,referrer:_,tncSchema:f})]}})})}()}})}function Wt(e){var t=e.tncServiceWorkerManager,r=De({normalFetch:fetch,tncServiceWorkerManager:t,pluginOptions:e.pluginOptions});r.isTncProxyFetch=!0;var n=r;x.fetch=n}return v.BestRoutingPlugin=_e,v.DynamicRoutingManager=qe,v.DynamicRoutingPlugin=ye,v.EliminationPlugin=Se,v.IndexedDbUtilCore=Me,v.MESSAGE_TNC_UPDATE_DYNAMIC_ROUTING=Oe,v.MESSAGE_TNC_UPDATE_SCHEMA=Ee,v.TncCore=Ae,v.TncManager=Dt,v.TncSchemaManager=Ne,v.TncServiceWorkerManager=Gt,v.bestRoutingUrlDispatch=ge,v.checkNeedDispatchAction=it,v.checkSupportIndexedDb=pt,v.dynamicRoutingUrlDispatch=me,v.eliminationUrlDispatch=be,v.fetchTncSchema=Ie,v.fetchTncSchemaAndStore=ee,v.getBestRoutingResult=te,v.getBestRoutingStoreDataToCache=He,v.getDynamicRoutingResult=Y,v.getDynamicRoutingStoreDataToCache=Ge,v.getEliminationResult=oe,v.getEliminationStoreDataToCache=Ve,v.getTncSchemaFromStore=K,v.operateOneTable=B,v.postMessageToSw=le,v.processTtnetDispatchActionWithPlugin=Te,v.proxyFetch=Bt,v.proxyFetchInSw=Wt,v.proxyXhr=Lt,v.putTncSchemaToStore=ve,v.saveBestRoutingResult=re,v.saveEliminationResult=ae,v.saveRoutingResultToStore=pe,v.setDynamicRoutingStoreDataToCache=We,v.tncFetchFactory=De,v.tncProcessFetch=at,v.tncProcessFetchFactory=we,v.tncProcessUrl=st,v.tncProcessUrlWithPlugin=ct,v.tncStore=A,Object.defineProperty(v,"__esModule",{value:!0}),v}({});
